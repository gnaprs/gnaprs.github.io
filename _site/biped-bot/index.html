<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>A self-balancing biped bot &#8211; Marion Pang</title> <meta name="description" content="Marion's personal website in the making."> <meta name="keywords" content="electronics, engineering"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="https://gnaprs.github.io/assets/img/marion_circle.png"> <meta name="twitter:title" content="A self-balancing biped bot"> <meta name="twitter:description" content="Using PID control to make a self-balancing biped bot."> <meta name="twitter:site" content="@srpang"> <meta name="twitter:creator" content="@srpang"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="A self-balancing biped bot"> <meta property="og:description" content="Using PID control to make a self-balancing biped bot."> <meta property="og:url" content="https://gnaprs.github.io/biped-bot/"> <meta property="og:site_name" content="Marion Pang"> <meta property="og:image" content="https://gnaprs.github.io/assets/img/marion_circle.png"> <link rel="canonical" href="https://gnaprs.github.io/biped-bot/"> <link href="https://gnaprs.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="Marion Pang Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="https://gnaprs.github.io/assets/css/main.css"> <!-- JS --> <script src="https://gnaprs.github.io/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="https://gnaprs.github.io/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="https://gnaprs.github.io/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="https://gnaprs.github.io/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="https://gnaprs.github.io/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="https://gnaprs.github.io/favicon.png" /> <link rel="shortcut icon" href="https://gnaprs.github.io/favicon.ico" /> <!-- Background Image --> <style type="text/css">body {background-image:url(https://gnaprs.github.io/assets/img/placeholder_big_compress.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="https://gnaprs.github.io/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="https://gnaprs.github.io/assets/img/marion_circle.png" alt="Marion Pang photo" class="author-photo"> <h4>Marion Pang</h4> <p>Marion's personal website in the making.</p> </li> <li><a href="https://gnaprs.github.io/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="mailto:sr_pang@hotmail.com" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-envelope-square"></i> Email</a> </li> <li> <a href="http://twitter.com/srpang" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://facebook.com/mpangwr" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a> </li> <li> <a href="http://linkedin.com/in/marionpang" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/gnaprs" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> <li> <a href="http://steamcommunity.com/id/srpang" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-steam-square"></i> Steam</a> </li> </ul><!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="https://gnaprs.github.io/posts/">All Posts</a></li> <li><a href="https://gnaprs.github.io/tags/">All Tags</a></li> </ul> </li> <li><a href="https://gnaprs.github.io/projects/" >Projects</a></li> <li><a href="https://github.com/gnaprs" target="_blank" rel="noopener noreferrer">Github</a></li> </ul><!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>A self-balancing biped bot</h1> <h4>18 Dec 2019</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~10 minutes </p><!-- /.entry-reading-time --> <a class="btn zoombtn" href="https://gnaprs.github.io/projects/"> <i class="fa fa-chevron-left"></i> </a> </div> <p class="notice">A self-balancing biped bot!! How cool is that?? (Robot, Sensors and Actuators final project) <br /> Credit: Ruby Liu, <b>Marion Pang<b></b></b></p> <h1 id="introduction">Introduction</h1> <p>In this project, we develop a simple self-balancing 2-wheeled RC robot, using the accelerometer and PID control to maintain balance while accepting user input for movement. The robot’s movement is controlled using bluetooth by a simple GUI on the Processing software on a computer.</p> <figure class="half"> <img src="https://gnaprs.github.io/assets/img/projects/bipedbot/bot3.png" /> <img src="https://gnaprs.github.io/assets/img/projects/bipedbot/bot4.jpg" /> <figcaption>(Left) Side view of self-balancing robot and (Right) robot communication via bluetooth with the Processing.js program.</figcaption> </figure> <figure class="half"> <img src="https://gnaprs.github.io/assets/img/projects/bipedbot/bot1.png" /> <img src="https://gnaprs.github.io/assets/img/projects/bipedbot/bot2.png" /> <figcaption>Top (left) and front (right) view of self-balancing robot.</figcaption> </figure> <h2 id="robot-schematics">Robot Schematics</h2> <p>Our robot consists of a piece of acrylic mounted with an Arduino Uno (with a breadboard shield) and two DC motors with wheels attached. The Arduino and motors are hot-glued to the acrylic. A 9V battery is attached to one of the motors using double-sided tape, and an additional power pack is often necessary to run the robot.</p> <figure class="half"> <img src="https://gnaprs.github.io/assets/img/projects/bipedbot/bot.jpg" /> <img src="https://gnaprs.github.io/assets/img/projects/bipedbot/circuit.png" /> <figcaption>Illustration of self-balancing robot and its components.</figcaption> </figure> <h2 id="sensors">Sensors</h2> <h3 id="minimu-9-v5-gyro">MinIMU-9 v5 Gyro</h3> <p>The MinIMU-9 v5 Gyro/Accelerometer was used to measure the orientation of the robot. Specifically, the <code class="highlighter-rouge">arctan</code> of the ratio of <code class="highlighter-rouge">y</code> and <code class="highlighter-rouge">z</code> axis accelerometer readings were taken to calculate the angle of inclination of the robot. These readings act as the input to the control loop, and are compared to the initial set point, which can be calibrated by the user to be at the robot’s center of gravity, to determine the robot’s next movement and speed (e.g. forward/backward/stop).</p> <figure class="half"> <img src="https://gnaprs.github.io/assets/img/projects/bipedbot/gyro1.png" /> <img src="https://gnaprs.github.io/assets/img/projects/bipedbot/gyro2.png" /> <figcaption>Illustration of change in angle measured by gyroscope in an unbalanced state (left and right) and a balanced state (middle). Circuit Wiring for MiniIMU-9 Gyroscope.</figcaption> </figure> <h3 id="hc-05-bluetooth-module">HC-05 Bluetooth Module</h3> <p>The HC-05 bluetooth module can be used to enable 2-way communication between an Arduino and any device with bluetooth functionality. In our project, we developed a simple GUI using Processing.js that sends commands via bluetooth to the HC-05 module, which is then used to control the movements of the RC robot. The HC-05 Bluetooth module communicates with the arduino via the Serial Port Protocol (SPP) to transmit serial data.</p> <figure> <img src="https://gnaprs.github.io/assets/img/projects/bipedbot/bluetooth1.png" /> </figure> <figure> <img src="https://gnaprs.github.io/assets/img/projects/bipedbot/bluetooth2.png" /> </figure> <p>Typically, Arduino and Bluetooth RX (receive pin) only accepts a logic voltage level of 3.3V. As the Arduino TX (transmit pin) has a 5V output, we used a voltage divider to drop the voltage down to an acceptable level of 3.3V for the Bluetooth RX to prevent burnout of the module. The Bluetooth module runs at a voltage of 3.3V, and also outputs serial data at 3.3V - as such, there was no need for a voltage divider circuit to lower the voltage for the Arduino RX.</p> <h2 id="actuators">Actuators</h2> <h3 id="dc-motors">DC Motors</h3> <p>The main actuators of the robot comprises of 2 DC hobby motors that run from 0-9V. In our robot, the voltage output is limited to the voltage of the battery - which ranges from between 7.6 to 8.8V. The direction of the motor is controlled using 2 digital <code class="highlighter-rouge">OUTPUT</code> pins (corresponding to forward and back) and the magnitude of voltage is controlled using an analog <code class="highlighter-rouge">OUTPUT</code> pin. The respective direction and magnitude signals are then fed into an H-bridge, which controls both motors. Notably, we invert the direction of the right motor from the left to ensure that both wheels move in the same direction respective to the Arduino.</p> <h2 id="program">Program</h2> <h3 id="pid-control">PID Control</h3> <p>PID control is a controller system that uses a control loop feedback mechanism to stabilize process variables. The problem we want to solve is simple - we are measuring the tilt of our bot (process variable) and we want to ensure that the bot remains upright (setpoint) as it moves. With relation to a PID controller, we feed our error value (<code class="highlighter-rouge">PV - DV</code>) into the controller with a <code class="highlighter-rouge">proportional</code>, <code class="highlighter-rouge">integral</code> and <code class="highlighter-rouge">differentiator</code> gain, and applies the correction to the bot.</p> <p>\[u(t) = K_pe(t)+K_i\int e(t)dt+K_p\frac{de}{dt} \] \(K_p \) = proportional gain <br /> \(e(t) \) = error value <br /> \(K_i \) = integral gain <br /> \(d(e) \) = change in error value <br /> \(d(t) \) = change in time <br /></p> <p>The robot is programmed with proportional feedback control to maintain its balance in conjunction with user input. The robot keeps track of its current orientation using the accelerometer readings - these readings are fed back in a negative feedback loop to help the robot correct its position back to baseline, which is either the starting position, the “forward” position, or the “backward” position, which can be changed using a bluetooth GUI.</p> <p>We also considered integral and derivative control, both of which worsened the stability instead of improving it—so we removed both. Finally, the <b>optimized value of <code class="highlighter-rouge">Kprop</code> was found to be 90.<b></b></b></p> <h4 id="arduino-pid-control">Arduino PID Control</h4> <p>At the start of the Arduino program, the program records the current position and uses that as the balance point. This can be recalibrated by hitting the reset button. Then, the user must press a push button to activate the balancing program.</p> <h4 id="laptop-processing-bluetooth-controller">Laptop Processing Bluetooth Controller</h4> <p>We programmed a program on Processing.js to allow a laptop to function as a bluetooth controller. It displays a three-button GUI for forward movement, backward movement, and no movement. The laptop is first connected via Bluetooth to the HC-05 module, which enables Serial communication between the Arduino and the program. When a button is pressed, the laptop sends the respective signal (<kbd>F</kbd> for forwards/<kbd>B</kbd> for backwards/<kbd>S</kbd> for stop) to the Bluetooth module, which then transmits the character to the Arduino microcontroller. The Arduino interprets each character as a move signal and offsets its current balancing signal by that respective amount. This tilts the bot forwards/backwards, enabling the desired forward or backwards motion. The laptop will continuously transmit the signal corresponding to the last button pressed, which is received by the Arduino to adjust the baseline position.</p> <h4 id="arduino-bot-code">Arduino bot code</h4> <div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;Wire.h&gt;
#include &lt;LSM6.h&gt;
#include &lt;math.h&gt;
</span>
<span class="n">LSM6</span> <span class="n">imu</span><span class="p">;</span>

<span class="kt">int16_t</span> <span class="n">accY</span><span class="p">,</span> <span class="n">accZ</span><span class="p">,</span> <span class="n">accX</span><span class="p">;</span> <span class="c1">// accelerometer readings
</span><span class="kt">double</span> <span class="n">accAngle</span><span class="p">;</span> <span class="c1">// calculated angle
</span><span class="kt">float</span> <span class="n">startAngle</span><span class="p">;</span>
<span class="kt">double</span> <span class="n">prevAngle</span> <span class="o">=</span> <span class="n">PI</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">startAngle</span><span class="p">;</span>

<span class="c1">//float angVel;
</span><span class="kt">float</span> <span class="n">angleError</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">prevError</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">errDeriv</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">sig</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">Kprop</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span> <span class="c1">// V/rad; ranges from 70+
</span><span class="kt">float</span> <span class="n">KD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">KI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">currTime</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prevTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">deltaT</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">posPin</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// + terminal motor pin
</span><span class="kt">int</span> <span class="n">negPin</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="c1">// - terminal motor pin
</span><span class="kt">int</span> <span class="n">enPin</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// enable 1 pin
</span><span class="kt">int</span> <span class="n">pos2Pin</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="c1">// + terminal motor pin
</span><span class="kt">int</span> <span class="n">neg2Pin</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="c1">// - terminal motor pin
</span><span class="kt">int</span> <span class="n">en2Pin</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span> <span class="c1">// enable 1 pin
</span>
<span class="kt">int</span> <span class="n">buttonPin</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>

<span class="c1">// For Bluetooth
</span><span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">LEDpin</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">moveSig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// set pins
</span>  <span class="n">pinMode</span><span class="p">(</span><span class="n">buttonPin</span><span class="p">,</span> <span class="n">INPUT_PULLUP</span><span class="p">);</span>

  <span class="n">pinMode</span><span class="p">(</span><span class="n">posPin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span> <span class="c1">// + terminal motor pin
</span>  <span class="n">pinMode</span><span class="p">(</span><span class="n">negPin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span> <span class="c1">// - terminal motor pin
</span>  <span class="n">pinMode</span><span class="p">(</span><span class="n">enPin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span> <span class="c1">// enable 1 pin
</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">pos2Pin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span> <span class="c1">// + terminal motor pin
</span>  <span class="n">pinMode</span><span class="p">(</span><span class="n">neg2Pin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span> <span class="c1">// - terminal motor pin
</span>  <span class="n">pinMode</span><span class="p">(</span><span class="n">en2Pin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span> <span class="c1">// enable 1 pin
</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">LEDpin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>

  <span class="c1">// set up accelerometer
</span>  <span class="n">Wire</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imu</span><span class="p">.</span><span class="n">init</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="c1">//Serial.println("Failed to detect and initialize IMU!");
</span>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">imu</span><span class="p">.</span><span class="n">enableDefault</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// read accelerometer data
</span>  <span class="n">imu</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>

  <span class="n">accZ</span> <span class="o">=</span> <span class="n">imu</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
  <span class="n">accY</span> <span class="o">=</span> <span class="n">imu</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
  <span class="n">accX</span> <span class="o">=</span> <span class="n">imu</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

  <span class="n">startAngle</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">accY</span><span class="p">,</span> <span class="n">accZ</span><span class="p">);</span> <span class="c1">// calculate start angle from current position
</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">buttonPin</span><span class="p">)</span> <span class="o">==</span> <span class="n">HIGH</span><span class="p">)</span> <span class="p">{}</span>

  <span class="c1">// Balancing program
</span>  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Read bluetooth
</span>    <span class="k">if</span> <span class="p">(</span> <span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">()</span> <span class="p">)</span> <span class="c1">// if data is available to read
</span>    <span class="p">{</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">Serial</span><span class="p">.</span><span class="n">read</span><span class="p">();</span> <span class="c1">// read it and store it in 'val'
</span>    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">val</span> <span class="o">==</span> <span class="sc">'F'</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// move forward, gradually changing the signal
</span>      <span class="n">moveSig</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">moveSig</span> <span class="o">-</span> <span class="p">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">val</span> <span class="o">==</span> <span class="sc">'B'</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// move backward, gradually changing the signal
</span>      <span class="n">moveSig</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">moveSig</span> <span class="o">+</span> <span class="p">.</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// return signal (closer) to 0
</span>      <span class="n">moveSig</span> <span class="o">=</span> <span class="n">moveSig</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// read accelerometer
</span>    <span class="n">imu</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>

    <span class="n">accZ</span> <span class="o">=</span> <span class="n">imu</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
    <span class="n">accY</span> <span class="o">=</span> <span class="n">imu</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">accX</span> <span class="o">=</span> <span class="n">imu</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

    <span class="c1">// calculate angle position
</span>    <span class="n">accAngle</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">accY</span><span class="p">,</span> <span class="n">accZ</span><span class="p">);</span>
    <span class="n">accAngle</span> <span class="o">=</span> <span class="n">constrain</span><span class="p">(</span><span class="n">accAngle</span><span class="p">,</span> <span class="o">-</span><span class="n">PI</span><span class="p">,</span> <span class="n">PI</span><span class="p">);</span>

    <span class="n">angleError</span> <span class="o">=</span>  <span class="n">startAngle</span> <span class="o">-</span> <span class="n">accAngle</span><span class="p">;</span>

    <span class="c1">// debugging print statements
</span>    <span class="c1">//if (isnan(accAngle));
</span>    <span class="c1">//else {
</span>    <span class="c1">//  Serial.print(accAngle);
</span>    <span class="c1">//  Serial.print(" ");
</span>    <span class="c1">//  Serial.println(angleError);
</span>    <span class="c1">//}
</span>
    <span class="n">currTime</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
    <span class="n">deltaT</span> <span class="o">=</span> <span class="n">currTime</span> <span class="o">-</span> <span class="n">prevTime</span><span class="p">;</span>
    <span class="n">prevTime</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span> <span class="c1">// record time
</span>
    <span class="n">errDeriv</span> <span class="o">=</span> <span class="p">(</span><span class="n">angleError</span> <span class="o">-</span> <span class="n">prevError</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">deltaT</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">.);</span>
    <span class="n">prevError</span> <span class="o">=</span> <span class="n">angleError</span><span class="p">;</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">Kprop</span> <span class="o">*</span> <span class="n">angleError</span> <span class="o">+</span> <span class="n">KD</span> <span class="o">*</span> <span class="n">angleError</span> <span class="o">+</span> <span class="n">moveSig</span><span class="p">;</span>


    <span class="c1">// If the signal is positive, rotate positive
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">accAngle</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">PI</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//Serial.println("forward");
</span>      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">posPin</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span> <span class="n">digitalWrite</span><span class="p">(</span><span class="n">negPin</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pos2Pin</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span> <span class="n">digitalWrite</span><span class="p">(</span><span class="n">neg2Pin</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// if signal is negative, rotate negative
</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//Serial.println("backward");
</span>      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">negPin</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span> <span class="n">digitalWrite</span><span class="p">(</span><span class="n">posPin</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">neg2Pin</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span> <span class="n">digitalWrite</span><span class="p">(</span><span class="n">pos2Pin</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// convert signal to analog range
</span>    <span class="kt">int</span> <span class="n">sigNorm</span> <span class="o">=</span> <span class="n">constrain</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">sig</span> <span class="o">/</span> <span class="mi">9</span><span class="p">.</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="c1">// set the enable pin to the converted analog signal
</span>    <span class="n">analogWrite</span><span class="p">(</span><span class="n">enPin</span><span class="p">,</span> <span class="n">sigNorm</span><span class="p">);</span>
    <span class="n">analogWrite</span><span class="p">(</span><span class="n">en2Pin</span><span class="p">,</span> <span class="n">sigNorm</span><span class="p">);</span>


  <span class="p">}</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div> <h4 id="processing-code-from-receiver-side-requires-bluetooth-pairing">Processing code from receiver side (requires bluetooth pairing)</h4> <div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">//import class to set up serial connection with wiring board</span>
<span class="kr">import</span> <span class="nx">processing</span><span class="p">.</span><span class="nx">serial</span><span class="p">.</span><span class="o">*</span><span class="p">;</span>
<span class="nx">Serial</span> <span class="nx">port</span><span class="p">;</span>
<span class="c1">//button setup</span>
<span class="nx">color</span> <span class="nx">currentcolor</span><span class="p">;</span>
<span class="nx">RectButton</span> <span class="nx">upButton</span><span class="p">,</span> <span class="nx">downButton</span><span class="p">,</span> <span class="nx">stopButton</span><span class="p">;</span>
<span class="kr">boolean</span> <span class="nx">locked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
 
<span class="k">void</span> <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
   <span class="c1">//set up window</span>
   <span class="nx">size</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
   <span class="nx">color</span> <span class="nx">baseColor</span> <span class="o">=</span> <span class="nx">color</span><span class="p">(</span><span class="mi">102</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">102</span><span class="p">);</span>
   <span class="nx">currentcolor</span> <span class="o">=</span> <span class="nx">baseColor</span><span class="p">;</span>

   <span class="c1">// Obtain list of serial ports and connect to HC-05 Module</span>
   <span class="nx">println</span><span class="p">(</span><span class="nx">Serial</span><span class="p">.</span><span class="nx">list</span><span class="p">());</span>
   <span class="nx">port</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Serial</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">Serial</span><span class="p">.</span><span class="nx">list</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">9600</span><span class="p">);</span> <span class="c1">// COM8 (outgoing)</span>
   <span class="nx">println</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
   <span class="c1">// Define and create rectangle button #upButton</span>
   <span class="kr">int</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">125</span><span class="p">;</span>
   <span class="kr">int</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
   <span class="kr">int</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
   <span class="nx">color</span> <span class="nx">buttoncolor</span> <span class="o">=</span> <span class="nx">color</span><span class="p">(</span><span class="mi">153</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">102</span><span class="p">);</span>
   <span class="nx">color</span> <span class="nx">highlight</span> <span class="o">=</span> <span class="nx">color</span><span class="p">(</span><span class="mi">102</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">51</span><span class="p">);</span>
   <span class="nx">upButton</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RectButton</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">buttoncolor</span><span class="p">,</span> <span class="nx">highlight</span><span class="p">);</span>
   
   <span class="c1">// Define and create rectangle button #stopButton</span>
   <span class="nx">x</span> <span class="o">=</span> <span class="mi">125</span><span class="p">;</span>
   <span class="nx">y</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
   <span class="nx">size</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
   <span class="nx">buttoncolor</span> <span class="o">=</span> <span class="nx">color</span><span class="p">(</span><span class="mi">179</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
   <span class="nx">highlight</span> <span class="o">=</span> <span class="nx">color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">230</span><span class="p">);</span>
   <span class="nx">stopButton</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RectButton</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">buttoncolor</span><span class="p">,</span> <span class="nx">highlight</span><span class="p">);</span>
   
   <span class="c1">// Define and create rectangle button #downButton</span>
   <span class="nx">x</span> <span class="o">=</span> <span class="mi">125</span><span class="p">;</span>
   <span class="nx">y</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
   <span class="nx">size</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
   <span class="nx">buttoncolor</span> <span class="o">=</span> <span class="nx">color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">51</span><span class="p">);</span>
   <span class="nx">highlight</span> <span class="o">=</span> <span class="nx">color</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
   <span class="nx">downButton</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RectButton</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">buttoncolor</span><span class="p">,</span> <span class="nx">highlight</span><span class="p">);</span>

<span class="p">}</span>
 
<span class="k">void</span> <span class="nx">draw</span><span class="p">()</span> <span class="p">{</span>
   <span class="c1">// first, draw GUI</span>
   <span class="nx">background</span><span class="p">(</span><span class="nx">currentcolor</span><span class="p">);</span>
   <span class="nx">stroke</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
   <span class="nx">update</span><span class="p">(</span><span class="nx">mouseX</span><span class="p">,</span> <span class="nx">mouseY</span><span class="p">);</span>
   <span class="nx">upButton</span><span class="p">.</span><span class="nx">display</span><span class="p">();</span>
   <span class="nx">stopButton</span><span class="p">.</span><span class="nx">display</span><span class="p">();</span>
   <span class="nx">downButton</span><span class="p">.</span><span class="nx">display</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="k">void</span> <span class="nx">update</span><span class="p">(</span><span class="kr">int</span> <span class="nx">x</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// update GUI at each frame</span>
   <span class="k">if</span><span class="p">(</span><span class="nx">locked</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">upButton</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
      <span class="nx">downButton</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
      <span class="nx">stopButton</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">locked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">// if any of the F/B/S buttons are pressed</span>
   <span class="k">if</span><span class="p">(</span><span class="nx">mousePressed</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">upButton</span><span class="p">.</span><span class="nx">pressed</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// Forward button</span>
         <span class="nx">currentcolor</span> <span class="o">=</span> <span class="nx">upButton</span><span class="p">.</span><span class="nx">basecolor</span><span class="p">;</span>
         <span class="nx">port</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'F'</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">downButton</span><span class="p">.</span><span class="nx">pressed</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// Backwards button</span>
         <span class="nx">currentcolor</span> <span class="o">=</span> <span class="nx">downButton</span><span class="p">.</span><span class="nx">basecolor</span><span class="p">;</span>
         <span class="nx">port</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'B'</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">stopButton</span><span class="p">.</span><span class="nx">pressed</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// Stop button</span>
         <span class="nx">currentcolor</span> <span class="o">=</span> <span class="nx">stopButton</span><span class="p">.</span><span class="nx">basecolor</span><span class="p">;</span>
         <span class="nx">port</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'S'</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// set up button class and respective event listeners</span>
<span class="kr">class</span> <span class="nx">Button</span> <span class="p">{</span>
   <span class="kr">int</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">;</span>
   <span class="kr">int</span> <span class="nx">size</span><span class="p">;</span>
   <span class="nx">color</span> <span class="nx">basecolor</span><span class="p">,</span> <span class="nx">highlightcolor</span><span class="p">;</span>
   <span class="nx">color</span> <span class="nx">currentcolor</span><span class="p">;</span>
   <span class="kr">boolean</span> <span class="nx">over</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="kr">boolean</span> <span class="nx">pressed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="k">void</span> <span class="nx">update</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">over</span><span class="p">())</span> <span class="p">{</span>
         <span class="nx">currentcolor</span> <span class="o">=</span> <span class="nx">highlightcolor</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">currentcolor</span> <span class="o">=</span> <span class="nx">basecolor</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="kr">boolean</span> <span class="nx">pressed</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">over</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">locked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">locked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="kr">boolean</span> <span class="nx">over</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">void</span> <span class="nx">display</span><span class="p">()</span> <span class="p">{</span>
   <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// rectButton is a class that extends button with pre-determined GUI parameters</span>
<span class="kr">class</span> <span class="nx">RectButton</span> <span class="kr">extends</span> <span class="nx">Button</span> <span class="p">{</span>
   <span class="nx">RectButton</span><span class="p">(</span><span class="kr">int</span> <span class="nx">ix</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">iy</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">isize</span><span class="p">,</span> <span class="nx">color</span> <span class="nx">icolor</span><span class="p">,</span> <span class="nx">color</span> <span class="nx">ihighlight</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">ix</span><span class="p">;</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">iy</span><span class="p">;</span>
      <span class="nx">size</span> <span class="o">=</span> <span class="nx">isize</span><span class="p">;</span>
      <span class="nx">basecolor</span> <span class="o">=</span> <span class="nx">icolor</span><span class="p">;</span>
      <span class="nx">highlightcolor</span> <span class="o">=</span> <span class="nx">ihighlight</span><span class="p">;</span>
      <span class="nx">currentcolor</span> <span class="o">=</span> <span class="nx">basecolor</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="kr">boolean</span> <span class="nx">over</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="nx">overRect</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
         <span class="nx">over</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">over</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
       <span class="p">}</span>
    <span class="p">}</span>
   <span class="k">void</span> <span class="nx">display</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">stroke</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
      <span class="nx">fill</span><span class="p">(</span><span class="nx">currentcolor</span><span class="p">);</span>
      <span class="nx">rect</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">size</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
 
<span class="kr">boolean</span> <span class="nx">overRect</span><span class="p">(</span><span class="kr">int</span> <span class="nx">x</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">y</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">width</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">mouseX</span> <span class="o">&gt;=</span> <span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">mouseX</span> <span class="o">&lt;=</span> <span class="nx">x</span><span class="o">+</span><span class="nx">width</span> <span class="o">&amp;&amp;</span> <span class="nx">mouseY</span> <span class="o">&gt;=</span> <span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">mouseY</span> <span class="o">&lt;=</span> <span class="nx">y</span><span class="o">+</span><span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="https://gnaprs.github.io/tags/#electronics" title="Pages tagged electronics" class="tag"><span class="term">electronics</span></a><a href="https://gnaprs.github.io/tags/#engineering" title="Pages tagged engineering" class="tag"><span class="term">engineering</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://gnaprs.github.io/biped-bot/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=https://gnaprs.github.io/biped-bot/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=https://gnaprs.github.io/biped-bot/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="https://gnaprs.github.io/assets/js/jquery-1.12.0.min.js"></script> <script src="https://gnaprs.github.io/assets/js/jquery.dlmenu.min.js"></script> <script src="https://gnaprs.github.io/assets/js/jquery.goup.min.js"></script> <script src="https://gnaprs.github.io/assets/js/jquery.magnific-popup.min.js"></script> <script src="https://gnaprs.github.io/assets/js/jquery.fitvid.min.js"></script> <script src="https://gnaprs.github.io/assets/js/scripts.js"></script> <script type="text/javascript"> var disqus_shortname = 'gnaprs'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
